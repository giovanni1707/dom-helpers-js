<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DOM Helpers Reactive - Simple Test Suite</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .header {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    .stat {
      background: white;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .stat-value {
      font-size: 32px;
      font-weight: bold;
      color: #3498db;
    }
    .stat-label {
      color: #666;
      font-size: 14px;
      margin-top: 5px;
    }
    .test-section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .test-section h2 {
      margin: 0 0 15px 0;
      color: #2c3e50;
      border-bottom: 2px solid #3498db;
      padding-bottom: 10px;
    }
    .test-result {
      padding: 8px 12px;
      margin: 5px 0;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
    }
    .pass { background: #d4edda; color: #155724; }
    .fail { background: #f8d7da; color: #721c24; }
    .info { background: #d1ecf1; color: #0c5460; }
    button {
      background: #3498db;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover { background: #2980b9; }
    button:disabled { background: #95a5a6; cursor: not-allowed; }
    #progress {
      height: 4px;
      background: #3498db;
      width: 0%;
      transition: width 0.3s;
      margin-bottom: 20px;
      border-radius: 2px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üß™ DOM Helpers Reactive - Test Suite</h1>
    <p>Testing core features from Reactive-README.md</p>
    <button id="run-tests" onclick="runAllTests()">Run All Tests</button>
  </div>

  <div id="progress"></div>

  <div class="stats">
    <div class="stat">
      <div class="stat-value" id="total">0</div>
      <div class="stat-label">Total</div>
    </div>
    <div class="stat">
      <div class="stat-value" id="passed" style="color: #27ae60;">0</div>
      <div class="stat-label">Passed</div>
    </div>
    <div class="stat">
      <div class="stat-value" id="failed" style="color: #e74c3c;">0</div>
      <div class="stat-label">Failed</div>
    </div>
    <div class="stat">
      <div class="stat-value" id="duration">0ms</div>
      <div class="stat-label">Duration</div>
    </div>
  </div>

  <div id="results"></div>

  <!-- Mock DOM Helpers -->
  <script>
    if (typeof Elements === 'undefined') {
      window.Elements = {};
      window.Collections = {};
      window.Selector = { query: {}, queryAll: {} };
    }
  </script>

  <!-- Load Reactive Extension -->
   <script src="../src/dom-helpers.js"></script>
  <script src="../src/dom-helpers-reactive.js"></script>

  <!-- Test Suite -->
  <script>
    let totalTests = 0;
    let passedTests = 0;
    let failedTests = 0;
    let startTime = 0;

    function updateStats() {
      document.getElementById('total').textContent = totalTests;
      document.getElementById('passed').textContent = passedTests;
      document.getElementById('failed').textContent = failedTests;
      const duration = Date.now() - startTime;
      document.getElementById('duration').textContent = duration + 'ms';
    }

    function addResult(sectionId, message, passed) {
      const section = document.getElementById(sectionId);
      const result = document.createElement('div');
      result.className = `test-result ${passed ? 'pass' : 'fail'}`;
      result.textContent = `${passed ? '‚úì' : '‚úó'} ${message}`;
      section.appendChild(result);
    }

    function test(sectionId, name, fn) {
      totalTests++;
      try {
        fn();
        passedTests++;
        addResult(sectionId, name, true);
        return true;
      } catch (e) {
        failedTests++;
        addResult(sectionId, `${name}: ${e.message}`, false);
        console.error(e);
        return false;
      }
    }

    function assert(condition, msg) {
      if (!condition) throw new Error(msg || 'Assertion failed');
    }

    function assertEqual(actual, expected) {
      if (actual !== expected) {
        throw new Error(`Expected ${expected}, got ${actual}`);
      }
    }

    async function runAllTests() {
      document.getElementById('run-tests').disabled = true;
      document.getElementById('results').innerHTML = '';
      totalTests = 0;
      passedTests = 0;
      failedTests = 0;
      startTime = Date.now();

      const tests = [
        testBasicState,
        testComputed,
        testWatchers,
        testEffects,
        testRefs,
        testBindings,
        testCollections,
        testForms,
        testAsync,
        testStore,
        testComponent,
        testBatch,
        testUtilities
      ];

      for (let i = 0; i < tests.length; i++) {
        await new Promise(resolve => setTimeout(resolve, 10));
        await tests[i]();
        const progress = ((i + 1) / tests.length) * 100;
        document.getElementById('progress').style.width = progress + '%';
        updateStats();
      }

      // Final summary
      const results = document.getElementById('results');
      const summary = document.createElement('div');
      summary.className = 'test-section';
      summary.innerHTML = `
        <h2>üìä Summary</h2>
        <div class="test-result ${failedTests === 0 ? 'pass' : 'fail'}">
          ${failedTests === 0 ? 'üéâ All tests passed!' : `‚ö†Ô∏è ${failedTests} test(s) failed`}
        </div>
      `;
      results.appendChild(summary);

      document.getElementById('run-tests').disabled = false;
      updateStats();
    }

    // Test 1: Basic State
    async function testBasicState() {
      const section = document.createElement('div');
      section.className = 'test-section';
      section.id = 'test-basic';
      section.innerHTML = '<h2>1. Basic Reactive State</h2>';
      document.getElementById('results').appendChild(section);

      test('test-basic', 'Creates reactive state', () => {
        const state = Elements.state({ count: 0 });
        assert(Elements.isReactive(state));
      });

      test('test-basic', 'Reads and writes properties', () => {
        const state = Elements.state({ count: 0 });
        assertEqual(state.count, 0);
        state.count = 10;
        assertEqual(state.count, 10);
      });

      test('test-basic', 'Nested objects are reactive', () => {
        const state = Elements.state({ user: { name: 'John' } });
        state.user.name = 'Jane';
        assertEqual(state.user.name, 'Jane');
      });

      test('test-basic', 'Arrays are reactive', () => {
        const state = Elements.state({ items: [1, 2, 3] });
        state.items.push(4);
        assertEqual(state.items.length, 4);
      });
    }

    // Test 2: Computed
    async function testComputed() {
      const section = document.createElement('div');
      section.className = 'test-section';
      section.id = 'test-computed';
      section.innerHTML = '<h2>2. Computed Properties</h2>';
      document.getElementById('results').appendChild(section);

      test('test-computed', '$computed instance method', () => {
        const state = Elements.state({ first: 'John', last: 'Doe' });
        state.$computed('full', function() {
          return `${this.first} ${this.last}`;
        });
        assertEqual(state.full, 'John Doe');
      });

      test('test-computed', 'Computed updates automatically', () => {
        const state = Elements.state({ price: 10, qty: 2 });
        state.$computed('total', function() {
          return this.price * this.qty;
        });
        assertEqual(state.total, 20);
        state.qty = 5;
        assertEqual(state.total, 50);
      });

      test('test-computed', 'Standalone computed()', () => {
        const state = Elements.state({ x: 5 });
        Elements.computed(state, {
          doubled: () => state.x * 2
        });
        assertEqual(state.doubled, 10);
      });
    }

    // Test 3: Watchers
    async function testWatchers() {
      const section = document.createElement('div');
      section.className = 'test-section';
      section.id = 'test-watch';
      section.innerHTML = '<h2>3. Watchers</h2>';
      document.getElementById('results').appendChild(section);

      test('test-watch', '$watch fires on change', () => {
        const state = Elements.state({ count: 0 });
        let called = false;
        const unwatch = state.$watch('count', () => { called = true; });
        state.count = 5;
        assert(called);
        unwatch();
      });

      test('test-watch', 'Receives new and old values', () => {
        const state = Elements.state({ val: 1 });
        let newVal, oldVal;
        const unwatch = state.$watch('val', (n, o) => { newVal = n; oldVal = o; });
        state.val = 2;
        assertEqual(newVal, 2);
        assertEqual(oldVal, 1);
        unwatch();
      });
    }

    // Test 4: Effects
    async function testEffects() {
      const section = document.createElement('div');
      section.className = 'test-section';
      section.id = 'test-effects';
      section.innerHTML = '<h2>4. Effects</h2>';
      document.getElementById('results').appendChild(section);

      test('test-effects', 'Effect tracks dependencies', () => {
        const state = Elements.state({ count: 0 });
        let runs = 0;
        const cleanup = Elements.effect(() => {
          const val = state.count;
          runs++;
        });
        state.count = 1;
        assert(runs > 1);
        cleanup();
      });
    }

    // Test 5: Refs
    async function testRefs() {
      const section = document.createElement('div');
      section.className = 'test-section';
      section.id = 'test-refs';
      section.innerHTML = '<h2>5. Refs</h2>';
      document.getElementById('results').appendChild(section);

      test('test-refs', 'Creates ref', () => {
        const count = Elements.ref(0);
        assertEqual(count.value, 0);
        count.value = 10;
        assertEqual(count.value, 10);
      });

      test('test-refs', 'Multiple refs', () => {
        const { x, y } = Elements.refs({ x: 1, y: 2 });
        assertEqual(x.value, 1);
        assertEqual(y.value, 2);
      });
    }

    // Test 6: Bindings
    async function testBindings() {
      const section = document.createElement('div');
      section.className = 'test-section';
      section.id = 'test-bindings';
      section.innerHTML = '<h2>6. DOM Bindings</h2>';
      document.getElementById('results').appendChild(section);

      test('test-bindings', 'Binds to DOM element', () => {
        const div = document.createElement('div');
        div.id = 'test-bind';
        document.body.appendChild(div);
        
        const state = Elements.state({ msg: 'Hello' });
        const cleanup = Elements.bindings({
          '#test-bind': () => state.msg
        });
        
        assertEqual(div.textContent, 'Hello');
        cleanup();
        div.remove();
      });
    }

    // Test 7: Collections
    async function testCollections() {
      const section = document.createElement('div');
      section.className = 'test-section';
      section.id = 'test-collections';
      section.innerHTML = '<h2>7. Collections</h2>';
      document.getElementById('results').appendChild(section);

      test('test-collections', 'Creates collection', () => {
        const list = Elements.list([{ id: 1 }, { id: 2 }]);
        assertEqual(list.items.length, 2);
      });

      test('test-collections', '$add method', () => {
        const list = Elements.list([]);
        list.$add({ id: 1 });
        assertEqual(list.items.length, 1);
      });

      test('test-collections', '$clear method', () => {
        const list = Elements.list([{ id: 1 }]);
        list.$clear();
        assertEqual(list.items.length, 0);
      });
    }

    // Test 8: Forms
    async function testForms() {
      const section = document.createElement('div');
      section.className = 'test-section';
      section.id = 'test-forms';
      section.innerHTML = '<h2>8. Forms</h2>';
      document.getElementById('results').appendChild(section);

      test('test-forms', 'Creates form state', () => {
        const form = ReactiveState.form({ name: '' });
        assert(form.values);
        assert(form.errors);
      });

      test('test-forms', '$setValue method', () => {
        const form = ReactiveState.form({ name: '' });
        form.$setValue('name', 'John');
        assertEqual(form.values.name, 'John');
      });

      test('test-forms', 'isValid computed', () => {
        const form = ReactiveState.form({ name: '' });
        assert(form.isValid);
        form.$setError('name', 'Required');
        assert(!form.isValid);
      });
    }

    // Test 9: Async
    async function testAsync() {
      const section = document.createElement('div');
      section.className = 'test-section';
      section.id = 'test-async';
      section.innerHTML = '<h2>9. Async State</h2>';
      document.getElementById('results').appendChild(section);

      test('test-async', 'Creates async state', () => {
        const data = ReactiveState.async(null);
        assert(data.data === null);
        assert(data.loading === false);
      });

      // Async test - run separately
      totalTests++;
      try {
        const data = ReactiveState.async(null);
        const promise = data.$execute(async () => {
          await new Promise(r => setTimeout(r, 10));
          return { value: 42 };
        });
        assert(data.loading, 'Should be loading');
        await promise;
        assert(!data.loading, 'Should stop loading');
        assertEqual(data.data.value, 42);
        passedTests++;
        addResult('test-async', '$execute tracks loading', true);
      } catch (e) {
        failedTests++;
        addResult('test-async', `$execute tracks loading: ${e.message}`, false);
      }
    }

    // Test 10: Store
    async function testStore() {
      const section = document.createElement('div');
      section.className = 'test-section';
      section.id = 'test-store';
      section.innerHTML = '<h2>10. Store</h2>';
      document.getElementById('results').appendChild(section);

      test('test-store', 'Creates store with getters and actions', () => {
        const store = Elements.store(
          { count: 0 },
          {
            getters: { doubled: function() { return this.count * 2; } },
            actions: { inc(s) { s.count++; } }
          }
        );
        assertEqual(store.doubled, 0);
        store.inc();
        assertEqual(store.count, 1);
      });
    }

    // Test 11: Component
    async function testComponent() {
      const section = document.createElement('div');
      section.className = 'test-section';
      section.id = 'test-component';
      section.innerHTML = '<h2>11. Component</h2>';
      document.getElementById('results').appendChild(section);

      test('test-component', 'Creates component with lifecycle', () => {
        let mounted = false;
        const comp = Elements.component({
          state: { count: 0 },
          actions: { inc(s) { s.count++; } },
          mounted() { mounted = true; }
        });
        assert(mounted);
        comp.inc();
        assertEqual(comp.count, 1);
        comp.$destroy();
      });
    }

    // Test 12: Batch
    async function testBatch() {
      const section = document.createElement('div');
      section.className = 'test-section';
      section.id = 'test-batch';
      section.innerHTML = '<h2>12. Batch Updates</h2>';
      document.getElementById('results').appendChild(section);

      test('test-batch', 'Batches multiple updates', () => {
        const state = Elements.state({ a: 0, b: 0 });
        let runs = 0;
        const cleanup = Elements.effect(() => {
          const sum = state.a + state.b;
          runs++;
        });
        
        runs = 0;
        Elements.batch(() => {
          state.a = 1;
          state.b = 2;
        });
        assertEqual(runs, 1);
        cleanup();
      });
    }

    // Test 13: Utilities
    async function testUtilities() {
      const section = document.createElement('div');
      section.className = 'test-section';
      section.id = 'test-utils';
      section.innerHTML = '<h2>13. Utilities</h2>';
      document.getElementById('results').appendChild(section);

      test('test-utils', 'isReactive()', () => {
        const state = Elements.state({ count: 0 });
        assert(Elements.isReactive(state));
        assert(!Elements.isReactive({ count: 0 }));
      });

      test('test-utils', 'toRaw()', () => {
        const state = Elements.state({ count: 0 });
        const raw = Elements.toRaw(state);
        assert(!Elements.isReactive(raw));
      });

      test('test-utils', 'Pause/Resume', () => {
        const state = Elements.state({ count: 0 });
        let runs = 0;
        const cleanup = Elements.effect(() => {
          const val = state.count;
          runs++;
        });
        
        runs = 0;
        Elements.pause();
        state.count = 10;
        assertEqual(runs, 0);
        Elements.resume(false);
        cleanup();
      });
    }
  </script>
</body>
</html>
