/**
 * DOM Helpers Async Module
 * High-performance vanilla JavaScript async utilities with seamless DOM integration
 * 
 * Features:
 * - Debounce & Throttle utilities
 * - Enhanced Fetch with error handling, retries, timeouts
 * - Form submission helpers with validation
 * - Input sanitization for XSS protection
 * - Async event handlers
 * - Parallel request management
 * - Full integration with Elements, Collections, and Selector
 * 
 * @version 1.0.0
 * @license MIT
 */
!function(e){"use strict";function t(e,t=300,n={}){if("function"!=typeof e)throw new Error("[DOM Helpers Async] debounce: func must be a function");const{immediate:r=!1,maxWait:s=null}=n;let l=null,o=null,a=null;const i=function(...n){const i=r&&!l,c=Date.now();null===a&&(a=c);const u=()=>{l&&(clearTimeout(l),l=null),o&&(clearTimeout(o),o=null)},d=()=>(a=null,u(),e.apply(this,n));return u(),i?d():(l=setTimeout(d,t),s&&c-a>=s?d():void(s&&!o&&(o=setTimeout(d,s-(c-a)))))};return i.cancel=()=>{l&&(clearTimeout(l),l=null),o&&(clearTimeout(o),o=null),a=null},i.flush=function(...t){if(l||o){const n=e.apply(this,t);return i.cancel(),n}},i}function n(e,t=200,n={}){if("function"!=typeof e)throw new Error("[DOM Helpers Async] throttle: func must be a function");const{leading:r=!0,trailing:s=!0}=n;let l=null,o=null,a=null;const i=function(...n){const i=Date.now();l||r||(l=i);const c=t-(i-(l||0));return c<=0||c>t?(o&&(clearTimeout(o),o=null),l=i,a=e.apply(this,n)):!o&&s&&(o=setTimeout(()=>{l=r?Date.now():null,o=null,a=e.apply(this,n)},c)),a};return i.cancel=()=>{o&&(clearTimeout(o),o=null),l=null,a=null},i}function r(e,t={}){if("string"!=typeof e)return e;const{allowedTags:n=[],allowedAttributes:r=[],removeScripts:s=!0,removeEvents:l=!0,removeStyles:o=!1}=t;let a=e;if(s&&(a=a.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,""),a=a.replace(/javascript:/gi,""),a=a.replace(/on\w+\s*=/gi,"")),l&&(a=a.replace(/\s*on[a-z]+\s*=\s*["'][^"']*["']/gi,"")),o&&(a=a.replace(/\s*style\s*=\s*["'][^"']*["']/gi,"")),n.length>0){const e=new RegExp(`<(?!/?(?:${n.join("|")})\\b)[^>]+>`,"gi");a=a.replace(e,"")}else a=a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;");return a}function s(e){return new Promise(t=>setTimeout(t,e))}async function l(e,t={}){const{method:n="GET",headers:r={},body:l=null,timeout:o=1e4,retries:a=0,retryDelay:i=1e3,loadingIndicator:c=null,onSuccess:u=null,onError:d=null,onStart:f=null,onFinally:h=null,signal:p=null}=t;if(c)try{c.style?c.style.display="block":c.update&&c.update({style:{display:"block"}})}catch(e){console.warn("[DOM Helpers Async] Failed to show loading indicator:",e.message)}if(f&&"function"==typeof f)try{f()}catch(e){console.warn("[DOM Helpers Async] Error in onStart callback:",e.message)}const m={method:n,headers:{"Content-Type":"application/json",...r},signal:p};l&&(m.body="string"==typeof l?l:JSON.stringify(l));let y=null,g=0;for(;g<=a;)try{const t=new AbortController,n=setTimeout(()=>t.abort(),o),r=new AbortController;p&&p.addEventListener("abort",()=>r.abort()),t.signal.addEventListener("abort",()=>r.abort()),m.signal=r.signal;const s=await fetch(e,m);if(clearTimeout(n),!s.ok)throw new Error(`HTTP ${s.status}: ${s.statusText}`);const l=await s.json();if(c)try{c.style?c.style.display="none":c.update&&c.update({style:{display:"none"}})}catch(e){console.warn("[DOM Helpers Async] Failed to hide loading indicator:",e.message)}if(u&&"function"==typeof u)try{u(l,s)}catch(e){console.warn("[DOM Helpers Async] Error in onSuccess callback:",e.message)}if(h&&"function"==typeof h)try{h()}catch(e){console.warn("[DOM Helpers Async] Error in onFinally callback:",e.message)}return l}catch(e){y=e,g++,g<=a&&await s(i*g)}if(c)try{c.style?c.style.display="none":c.update&&c.update({style:{display:"none"}})}catch(e){console.warn("[DOM Helpers Async] Failed to hide loading indicator:",e.message)}if(d&&"function"==typeof d)try{d(y)}catch(e){console.warn("[DOM Helpers Async] Error in onError callback:",e.message)}if(h&&"function"==typeof h)try{h()}catch(e){console.warn("[DOM Helpers Async] Error in onFinally callback:",e.message)}throw y}async function o(e,t={}){return l(e,t)}async function a(e,t={}){return(await l(e,{...t,parseJSON:!1})).text()}async function i(e,t={}){return(await l(e,{...t,parseJSON:!1})).blob()}function c(e,t={}){const{errorHandler:n=null,loadingClass:r="loading",loadingAttribute:s="data-loading"}=t;return async function(t,...l){if("function"!=typeof e)return void console.error("[DOM Helpers Async] asyncHandler: handler must be a function");const o=t.target||t.currentTarget;try{o&&(r&&o.classList.add(r),s&&o.setAttribute(s,"true"))}catch(e){console.warn("[DOM Helpers Async] Failed to set loading state:",e.message)}try{return await e.call(this,t,...l)}catch(e){if(console.error("[DOM Helpers Async] Error in async handler:",e),n&&"function"==typeof n)try{n(e,t,...l)}catch(e){console.error("[DOM Helpers Async] Error in error handler:",e)}throw e}finally{try{o&&(r&&o.classList.remove(r),s&&o.removeAttribute(s))}catch(e){console.warn("[DOM Helpers Async] Failed to remove loading state:",e.message)}}}}function u(e,t={}){if(!e||!e.elements)return{isValid:!1,errors:["Invalid form element"]};const n=[];return Array.from(e.elements).forEach(e=>{const r=e.name;if(!r||!t[r])return;const s=t[r],l=e.value.trim();if(s.required&&!l)return n.push(`${s.label||r} is required`),void e.classList.add("error");if(l){if("email"!==s.type||/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(l)||(n.push(`${s.label||r} must be a valid email`),e.classList.add("error")),"url"!==s.type||/^https?:\/\/.+/.test(l)||(n.push(`${s.label||r} must be a valid URL`),e.classList.add("error")),"number"===s.type&&isNaN(parseFloat(l))&&(n.push(`${s.label||r} must be a number`),e.classList.add("error")),s.minLength&&l.length<s.minLength&&(n.push(`${s.label||r} must be at least ${s.minLength} characters`),e.classList.add("error")),s.maxLength&&l.length>s.maxLength&&(n.push(`${s.label||r} must be no more than ${s.maxLength} characters`),e.classList.add("error")),s.pattern&&!s.pattern.test(l)&&(n.push(s.message||`${s.label||r} format is invalid`),e.classList.add("error")),s.validator&&"function"==typeof s.validator)try{const t=s.validator(l,e);!0!==t&&"string"==typeof t&&(n.push(t),e.classList.add("error"))}catch(e){console.warn("[DOM Helpers Async] Error in custom validator:",e.message)}n.some(e=>e.includes(s.label||r))||e.classList.remove("error")}}),{isValid:0===n.length,errors:n}}function d(e,t={}){if(!e||!e.elements)return{};const{includeEmpty:n=!1,transform:r=null,excludeDisabled:s=!0}=t,l={},o=new FormData(e);for(const[t,r]of o.entries()){const o=e.elements[t];s&&o&&o.disabled||(n||r&&""!==r.toString().trim())&&(l.hasOwnProperty(t)?Array.isArray(l[t])?l[t].push(r):l[t]=[l[t],r]:l[t]=r)}if(r&&"function"==typeof r)try{return r(l)}catch(e){return console.warn("[DOM Helpers Async] Error in form data transformation:",e.message),l}return l}function f(e,t,n="info",r={}){const{duration:s=5e3,className:l="form-message",container:o=null}=r;let a=o||e.querySelector(`.${l}`);return a?a.className=`${l} ${l}--${n}`:(a=document.createElement("div"),a.className=`${l} ${l}--${n}`,e.firstChild?e.insertBefore(a,e.firstChild):e.appendChild(a)),a.textContent=t,a.style.display="block",s>0&&setTimeout(()=>{a&&a.parentNode&&(a.style.display="none")},s),a}async function h(e,t={}){const{onProgress:n=null,failFast:r=!0}=t;if(!Array.isArray(e))throw new Error("[DOM Helpers Async] parallelAll: promises must be an array");if(r)return Promise.all(e);const s=[];let l=0;for(let t=0;t<e.length;t++){try{const n=await e[t];s[t]={status:"fulfilled",value:n}}catch(e){s[t]={status:"rejected",reason:e}}if(l++,n&&"function"==typeof n)try{n(l,e.length,s[t])}catch(e){console.warn("[DOM Helpers Async] Error in progress callback:",e.message)}}return s}async function p(e,t=5e3){const n=new Promise((e,n)=>{setTimeout(()=>n(new Error("Operation timed out")),t)});return Promise.race([...e,n])}function m(){if(void 0!==e){if(e.AsyncHelpers={debounce:t,throttle:n,sanitize:r,sleep:s,fetch:l,fetchJSON:o,fetchText:a,fetchBlob:i,asyncHandler:c,validateForm:u,getFormData:d,showFormMessage:f,parallelAll:h,raceWithTimeout:p},e.Elements&&(Object.assign(e.Elements,{debounce:t,throttle:n,sanitize:r,sleep:s,fetch:l,fetchJSON:o,fetchText:a,fetchBlob:i,asyncHandler:c,validateForm:(e,t)=>u(e,t),getFormData:(e,t)=>d(e,t),showFormMessage:(e,t,n,r)=>f(e,t,n,r),parallelAll:h,raceWithTimeout:p}),e.Elements.helper&&e.Elements.helper._enhanceElementWithUpdate)){const t=e.Elements.helper._enhanceElementWithUpdate;e.Elements.helper._enhanceElementWithUpdate=function(e){const n=t.call(this,e);return n&&"FORM"===n.tagName&&(n.validate=function(e){return u(this,e)},n.getData=function(e){return d(this,e)},n.showMessage=function(e,t,n){return f(this,e,t,n)},n.submitAsync=function(e={}){const{validate:t=!0,validationRules:r={},onSuccess:s=null,onError:o=null,...a}=e;return c(async e=>{if(e.preventDefault(),t){const e=this.validate(r);if(!e.isValid){const t=e.errors.join(", ");return void this.showMessage(t,"error")}}const n=this.getData();return await l(this.action||window.location.href,{method:this.method||"POST",body:n,onSuccess:s,onError:o,...a})}).call(n)}),n}}e.Collections&&Object.assign(e.Collections,{debounce:t,throttle:n,sanitize:r,sleep:s,fetch:l,fetchJSON:o,fetchText:a,fetchBlob:i,asyncHandler:c,parallelAll:h,raceWithTimeout:p}),e.Selector&&Object.assign(e.Selector,{debounce:t,throttle:n,sanitize:r,sleep:s,fetch:l,fetchJSON:o,fetchText:a,fetchBlob:i,asyncHandler:c,parallelAll:h,raceWithTimeout:p})}}const y={debounce:t,throttle:n,sanitize:r,sleep:s,fetch:l,fetchJSON:o,fetchText:a,fetchBlob:i,asyncHandler:c,validateForm:u,getFormData:d,showFormMessage:f,parallelAll:h,raceWithTimeout:p,integrate:m,configure:(e={})=>{const{debounceDelay:t=300,throttleDelay:n=200,fetchTimeout:r=1e4,fetchRetries:s=0}=e;return y.config={debounceDelay:t,throttleDelay:n,fetchTimeout:r,fetchRetries:s},y},version:"1.0.0",isDOMHelpersAvailable:()=>!!(e.Elements||e.Collections||e.Selector)};"undefined"!=typeof document&&("loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{setTimeout(m,100)}):setTimeout(m,100)),m(),setTimeout(()=>{"undefined"!=typeof console&&y.isDOMHelpersAvailable()&&console.log("[DOM Helpers Async] Successfully integrated with DOM Helpers ecosystem")},200),"undefined"!=typeof module&&module.exports?module.exports=y:"function"==typeof define&&define.amd?define([],function(){return y}):(e.AsyncHelpers=y,e.debounce=t,e.throttle=n,e.sanitize=r)}("undefined"!=typeof window?window:"undefined"!=typeof global?global:this);