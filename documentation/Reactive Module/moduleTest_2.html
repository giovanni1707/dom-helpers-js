<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Integration Tests - DOM Helpers Reactive</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .demo-section {
      background: #f9f9f9;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      border: 1px solid #ddd;
    }
    
    .demo-section h3 {
      margin-top: 0;
      color: #333;
    }
    
    .controls {
      margin: 15px 0;
    }
    
    button {
      padding: 8px 16px;
      margin: 5px;
      border: none;
      border-radius: 4px;
      background: #4CAF50;
      color: white;
      cursor: pointer;
    }
    
    button:hover {
      background: #45a049;
    }
    
    input, select {
      padding: 8px;
      margin: 5px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    .output {
      background: white;
      padding: 15px;
      margin: 10px 0;
      border-radius: 4px;
      border: 1px solid #ddd;
      min-height: 30px;
    }
    
    .list-item {
      padding: 10px;
      margin: 5px 0;
      background: white;
      border-radius: 4px;
      border: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .error {
      color: #d32f2f;
      font-size: 0.9em;
    }
    
    .success {
      color: #388e3c;
      font-weight: bold;
    }
    
    .hidden {
      display: none;
    }
    
    .active {
      background: #e3f2fd;
      border-color: #2196F3;
    }
  </style>
</head>
<body>
  <h1>🔗 Integration Tests - DOM Helpers Reactive</h1>
  <p>Interactive demonstrations of reactive features</p>

  <!-- Demo 1: Basic Counter -->
  <div class="demo-section">
    <h3>1. Basic Counter</h3>
    <div class="controls">
      <button onclick="demo1.increment()">Increment</button>
      <button onclick="demo1.decrement()">Decrement</button>
      <button onclick="demo1.reset()">Reset</button>
    </div>
    <div class="output">
      <div>Count: <span id="counter-display">0</span></div>
      <div>Doubled: <span id="counter-doubled">0</span></div>
    </div>
  </div>

  <!-- Demo 2: Form Validation -->
  <div class="demo-section">
    <h3>2. Form Validation</h3>
    <div class="controls">
      <input type="email" id="email-input" placeholder="Enter email">
      <input type="password" id="password-input" placeholder="Enter password">
      <button onclick="demo2.submit()">Submit</button>
    </div>
    <div class="output">
      <div id="email-error" class="error"></div>
      <div id="password-error" class="error"></div>
      <div id="form-status"></div>
    </div>
  </div>

  <!-- Demo 3: Todo List -->
  <div class="demo-section">
    <h3>3. Todo List</h3>
    <div class="controls">
      <input type="text" id="todo-input" placeholder="New todo">
      <button onclick="demo3.add()">Add</button>
      <button onclick="demo3.clearCompleted()">Clear Completed</button>
    </div>
    <div id="todo-list" class="output"></div>
    <div class="output">
      Total: <span id="todo-total">0</span> | 
      Completed: <span id="todo-completed">0</span> | 
      Remaining: <span id="todo-remaining">0</span>
    </div>
  </div>

  <!-- Demo 4: Async Data Loading -->
  <div class="demo-section">
    <h3>4. Async Data Loading</h3>
    <div class="controls">
      <button onclick="demo4.load()">Load Data</button>
      <button onclick="demo4.loadError()">Simulate Error</button>
      <button onclick="demo4.reset()">Reset</button>
    </div>
    <div class="output">
      <div id="async-status"></div>
      <div id="async-data"></div>
    </div>
  </div>

  <!-- Demo 5: Conditional Rendering -->
  <div class="demo-section">
    <h3>5. Conditional Rendering</h3>
    <div class="controls">
      <select id="view-select" onchange="demo5.changeView(this.value)">
        <option value="home">Home</option>
        <option value="profile">Profile</option>
        <option value="settings">Settings</option>
      </select>
    </div>
    <div id="view-content" class="output"></div>
  </div>

  <!-- Demo 6: Nested Reactivity -->
  <div class="demo-section">
    <h3>6. Nested Object Reactivity</h3>
    <div class="controls">
      <input type="text" id="user-name" placeholder="Name">
      <input type="number" id="user-age" placeholder="Age">
      <input type="text" id="user-city" placeholder="City">
    </div>
    <div class="output">
      <div id="user-display"></div>
    </div>
  </div>

  <!-- Demo 7: Array Operations -->
  <div class="demo-section">
    <h3>7. Array Operations</h3>
    <div class="controls">
      <button onclick="demo7.push()">Push</button>
      <button onclick="demo7.pop()">Pop</button>
      <button onclick="demo7.shift()">Shift</button>
      <button onclick="demo7.unshift()">Unshift</button>
      <button onclick="demo7.reverse()">Reverse</button>
      <button onclick="demo7.sort()">Sort</button>
    </div>
    <div class="output">
      <div>Array: <span id="array-display">[]</span></div>
      <div>Length: <span id="array-length">0</span></div>
    </div>
  </div>

  <!-- Demo 8: Batch Updates -->
  <div class="demo-section">
    <h3>8. Batch Updates Performance</h3>
    <div class="controls">
      <button onclick="demo8.updateWithoutBatch()">Update Without Batch (Slow)</button>
      <button onclick="demo8.updateWithBatch()">Update With Batch (Fast)</button>
    </div>
    <div class="output">
      <div id="batch-status"></div>
      <div>Update count: <span id="batch-count">0</span></div>
    </div>
  </div>


 <script src="../../src/dom-helpers.js"></script>
  <script src="../../src/dom-helpers-reactive.js"></script>

  <!-- Mock DOM Helpers Core -->
  <script>
    window.Elements = {
      get: function(id) { return document.getElementById(id); }
    };
    window.Collections = {
      get: function(className) { return Array.from(document.getElementsByClassName(className)); }
    };
    window.Selector = {
      query: function(selector) { return document.querySelector(selector); },
      queryAll: function(selector) { return Array.from(document.querySelectorAll(selector)); }
    };
  </script>

  <!-- Load Reactive Module -->
  <script src="dom-helpers-reactive.js"></script>

  <!-- Demo Implementations -->
  <script>
    // Demo 1: Basic Counter
    const demo1 = (() => {
      const state = ReactiveState.create({ count: 0 });
      
      state.$computed('doubled', function() {
        return this.count * 2;
      });

      Elements.bind({
        'counter-display': () => state.count,
        'counter-doubled': () => state.doubled
      });

      return {
        increment: () => state.count++,
        decrement: () => state.count--,
        reset: () => state.count = 0
      };
    })();

    // Demo 2: Form Validation
    const demo2 = (() => {
      const form = ReactiveState.form({
        email: '',
        password: ''
      });

      // Validation rules
      function validateEmail(email) {
        return email.includes('@') && email.includes('.');
      }

      function validatePassword(password) {
        return password.length >= 8;
      }

      // Watch inputs
      document.getElementById('email-input').addEventListener('input', (e) => {
        form.$setValue('email', e.target.value);
        if (!validateEmail(e.target.value)) {
          form.$setError('email', 'Invalid email format');
        } else {
          form.$setError('email', null);
        }
      });

      document.getElementById('password-input').addEventListener('input', (e) => {
        form.$setValue('password', e.target.value);
        if (!validatePassword(e.target.value)) {
          form.$setError('password', 'Password must be at least 8 characters');
        } else {
          form.$setError('password', null);
        }
      });

      // Bind errors
      Elements.bind({
        'email-error': () => form.errors.email || '',
        'password-error': () => form.errors.password || '',
        'form-status': () => {
          if (!form.isDirty) return '';
          return form.isValid 
            ? '<span class="success">✓ Form is valid</span>' 
            : '<span class="error">✗ Please fix errors</span>';
        }
      });

      return {
        submit: () => {
          if (form.isValid) {
            alert('Form submitted successfully!');
            form.$reset();
            document.getElementById('email-input').value = '';
            document.getElementById('password-input').value = '';
          } else {
            alert('Please fix validation errors');
          }
        }
      };
    })();

    // Demo 3: Todo List
    const demo3 = (() => {
      const todos = ReactiveState.collection([
        { id: 1, text: 'Learn React', completed: false },
        { id: 2, text: 'Build app', completed: false }
      ]);

      todos.$computed('completedCount', function() {
        return this.items.filter(t => t.completed).length;
      });

      todos.$computed('remainingCount', function() {
        return this.items.length - this.completedCount;
      });

      function renderTodos() {
        return todos.items.map(todo => `
          <div class="list-item ${todo.completed ? 'active' : ''}">
            <span style="text-decoration: ${todo.completed ? 'line-through' : 'none'}">
              ${todo.text}
            </span>
            <div>
              <button onclick="demo3.toggle(${todo.id})">
                ${todo.completed ? 'Undo' : 'Complete'}
              </button>
              <button onclick="demo3.remove(${todo.id})">Delete</button>
            </div>
          </div>
        `).join('');
      }

      Elements.bind({
        'todo-list': {
          innerHTML: renderTodos
        },
        'todo-total': () => todos.items.length,
        'todo-completed': () => todos.completedCount,
        'todo-remaining': () => todos.remainingCount
      });

      return {
        add: () => {
          const input = document.getElementById('todo-input');
          const text = input.value.trim();
          if (text) {
            todos.$add({
              id: Date.now(),
              text,
              completed: false
            });
            input.value = '';
          }
        },
        toggle: (id) => {
          const todo = todos.items.find(t => t.id === id);
          if (todo) {
            todo.completed = !todo.completed;
          }
        },
        remove: (id) => {
          todos.$remove(t => t.id === id);
        },
        clearCompleted: () => {
          todos.items = todos.items.filter(t => !t.completed);
        }
      };
    })();

    // Demo 4: Async Data Loading
    const demo4 = (() => {
      const asyncState = ReactiveState.async(null);

      Elements.bind({
        'async-status': () => {
          if (asyncState.loading) return 'Loading...';
          if (asyncState.isError) return `<span class="error">Error: ${asyncState.error.message}</span>`;
          if (asyncState.isSuccess) return '<span class="success">✓ Data loaded</span>';
          return 'Click "Load Data" to start';
        },
        'async-data': () => {
          if (asyncState.data) {
            return `<pre>${JSON.stringify(asyncState.data, null, 2)}</pre>`;
          }
          return '';
        }
      });

      return {
        load: async () => {
          await asyncState.$execute(async () => {
            await new Promise(resolve => setTimeout(resolve, 1500));
            return {
              users: ['Alice', 'Bob', 'Charlie'],
              timestamp: new Date().toISOString()
            };
          });
        },
        loadError: async () => {
          try {
            await asyncState.$execute(async () => {
              await new Promise(resolve => setTimeout(resolve, 1000));
              throw new Error('Failed to fetch data');
            });
          } catch (e) {
            // Error handled by async state
          }
        },
        reset: () => asyncState.$reset()
      };
    })();

    // Demo 5: Conditional Rendering
    const demo5 = (() => {
      const state = ReactiveState.create({ currentView: 'home' });

      const views = {
        home: '<h4>🏠 Home</h4><p>Welcome to the home page!</p>',
        profile: '<h4>👤 Profile</h4><p>User profile information goes here.</p>',
        settings: '<h4>⚙️ Settings</h4><p>Application settings and preferences.</p>'
      };

      Elements.bind({
        'view-content': {
          innerHTML: () => views[state.currentView]
        }
      });

      return {
        changeView: (view) => {
          state.currentView = view;
        }
      };
    })();

    // Demo 6: Nested Reactivity
    const demo6 = (() => {
      const state = ReactiveState.create({
        user: {
          name: 'John Doe',
          age: 30,
          address: {
            city: 'New York'
          }
        }
      });

      document.getElementById('user-name').addEventListener('input', (e) => {
        state.user.name = e.target.value;
      });

      document.getElementById('user-age').addEventListener('input', (e) => {
        state.user.age = parseInt(e.target.value) || 0;
      });

      document.getElementById('user-city').addEventListener('input', (e) => {
        state.user.address.city = e.target.value;
      });

      Elements.bind({
        'user-display': () => `
          <strong>${state.user.name}</strong> (${state.user.age} years old)<br>
          Lives in: ${state.user.address.city}
        `
      });

      // Set initial values
      document.getElementById('user-name').value = state.user.name;
      document.getElementById('user-age').value = state.user.age;
      document.getElementById('user-city').value = state.user.address.city;

      return {};
    })();

    // Demo 7: Array Operations
    const demo7 = (() => {
      const state = ReactiveState.create({ 
        numbers: [1, 2, 3, 4, 5]
      });

      Elements.bind({
        'array-display': () => JSON.stringify(state.numbers),
        'array-length': () => state.numbers.length
      });

      return {
        push: () => {
          const max = Math.max(...state.numbers);
          state.numbers.push(max + 1);
        },
        pop: () => state.numbers.pop(),
        shift: () => state.numbers.shift(),
        unshift: () => {
          const min = Math.min(...state.numbers);
          state.numbers.unshift(min - 1);
        },
        reverse: () => state.numbers.reverse(),
        sort: () => state.numbers.sort((a, b) => a - b)
      };
    })();

    // Demo 8: Batch Updates
    const demo8 = (() => {
      const state = ReactiveState.create({ count: 0 });
      let updateCount = 0;

      Elements.bind({
        'batch-count': () => {
          updateCount++;
          return state.count;
        },
        'batch-status': () => ''
      });

      return {
        updateWithoutBatch: () => {
          updateCount = 0;
          const start = performance.now();
          
          for (let i = 0; i < 100; i++) {
            state.count = i;
          }
          
          setTimeout(() => {
            const duration = performance.now() - start;
            document.getElementById('batch-status').innerHTML = 
              `Completed in ${duration.toFixed(2)}ms with ${updateCount} DOM updates`;
          }, 100);
        },
        updateWithBatch: () => {
          updateCount = 0;
          const start = performance.now();
          
          ReactiveState.batch(() => {
            for (let i = 0; i < 100; i++) {
              state.count = i;
            }
          });
          
          setTimeout(() => {
            const duration = performance.now() - start;
            document.getElementById('batch-status').innerHTML = 
              `Completed in ${duration.toFixed(2)}ms with ${updateCount} DOM updates (batched)`;
          }, 100);
        }
      };
    })();

    console.log('✅ All demos initialized and ready!');
  </script>
</body>
</html>