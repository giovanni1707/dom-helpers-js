/**
 * DOM Helpers Components - Traditional HTML5 Component System
 * Extends DOM Helpers with vanilla JavaScript component architecture
 * Fully compatible with all DOM Helpers libraries (async, form, storage, animation)
 * 
 * Features:
 * - Traditional HTML5 structure with IDs and classes
 * - Seamless Elements, Collections, Selector integration
 * - Component-based architecture with vanilla JavaScript
 * - Scoped CSS with automatic isolation
 * - Event delegation and custom events
 * - Full DOM Helpers .update() compatibility
 * - Lifecycle management
 * - Data binding through DOM Helpers philosophy
 * 
 * @version 2.0.0
 * @license MIT
 */
!function(e){"use strict";const t=["Elements","Collections","Selector"].filter(t=>void 0===e[t]);t.length>0&&console.warn("[DOM Components] Missing DOM Helpers libraries:",t.join(", "));const n=new Map,s=new WeakMap,o=new Map,i=new WeakMap;let r=0;class a{constructor(e,t,n,o={}){this.id="comp-"+ ++r,this.name=e,this.definition=t,this.container=n,this.data={...o},this.children=new Set,this.isDestroyed=!1,this.isMounted=!1,this.scopeId=`data-component-${this.id}`,this.lifecycle={beforeMount:[],mounted:[],beforeUpdate:[],updated:[],beforeDestroy:[],destroyed:[]},this._parseDefinition(),s.set(n,this),i.set(this,this.data)}_parseDefinition(){"string"==typeof this.definition?(this.template=this._extractTemplate(this.definition),this.styles=this._extractStyles(this.definition),this.script=this._extractScript(this.definition)):"object"==typeof this.definition&&(this.template=this.definition.template||"",this.styles=this.definition.styles||"",this.script=this.definition.script||"")}_extractTemplate(e){return e.replace(/<style[^>]*>[\s\S]*?<\/style>/gi,"").replace(/<script[^>]*>[\s\S]*?<\/script>/gi,"").trim()}_extractStyles(e){const t=e.match(/<style[^>]*>([\s\S]*?)<\/style>/i);return t?t[1].trim():""}_extractScript(e){const t=e.match(/<script[^>]*>([\s\S]*?)<\/script>/i);return t?t[1].trim():""}async render(){if(!this.isDestroyed)try{return await this._callLifecycle("beforeMount"),this.styles&&this._injectScopedStyles(),this._createDOM(),this.styles&&this._applyScopeAttributes(),this.script&&await this._executeScript(),await this._processNestedComponents(),this._enhanceWithDOMHelpers(),this.isMounted=!0,await this._callLifecycle("mounted"),this}catch(e){throw console.error(`[DOM Components] Error rendering component ${this.name}:`,e),e}}_createDOM(){this.container.innerHTML="",this.container.innerHTML=this.template,this.root=1===this.container.children.length?this.container.firstElementChild:this.container}_injectScopedStyles(){if(o.has(this.scopeId))return;const e=this._scopeCSS(this.styles),t=document.createElement("style");t.setAttribute("data-component",this.name),t.setAttribute("data-scope",this.scopeId),t.textContent=e,document.head.appendChild(t),o.set(this.scopeId,t)}_scopeCSS(e){return e.replace(/([^{}]+)\{/g,(e,t)=>{const n=t.trim();if(n.startsWith("@")||n.startsWith("/*")||n.includes("keyframes"))return e;return`${n.split(",").map(e=>`[${this.scopeId}] ${e.trim()}`).join(", ")} {`})}_applyScopeAttributes(){this.container.setAttribute(this.scopeId,"");this.container.querySelectorAll("*").forEach(e=>{e.setAttribute(this.scopeId,"")})}async _executeScript(){try{const t={component:this,container:this.container,root:this.root,data:this.data,Elements:e.Elements,Collections:e.Collections,Selector:e.Selector,getData:()=>this.data,setData:e=>this.updateData(e),emit:(e,t)=>this.emit(e,t),destroy:()=>this.destroy(),onBeforeMount:e=>this.lifecycle.beforeMount.push(e),onMounted:e=>this.lifecycle.mounted.push(e),onBeforeUpdate:e=>this.lifecycle.beforeUpdate.push(e),onUpdated:e=>this.lifecycle.updated.push(e),onBeforeDestroy:e=>this.lifecycle.beforeDestroy.push(e),onDestroyed:e=>this.lifecycle.destroyed.push(e),console:console,setTimeout:setTimeout,setInterval:setInterval,clearTimeout:clearTimeout,clearInterval:clearInterval,fetch:"undefined"!=typeof fetch?fetch:void 0,...e.DOMHelpersAsync?{Async:e.DOMHelpersAsync}:{},...e.DOMHelpersForm?{Form:e.DOMHelpersForm}:{},...e.DOMHelpersStorage?{Storage:e.DOMHelpersStorage}:{},...e.DOMHelpersAnimation?{Animation:e.DOMHelpersAnimation}:{}},n=new Function(...Object.keys(t),this.script);await n.apply(this,Object.values(t))}catch(e){throw console.error(`[DOM Components] Error executing script for ${this.name}:`,e),e}}async _processNestedComponents(){const e=this.container.querySelectorAll("[data-component]");for(const t of e){const e=t.getAttribute("data-component");if(e&&l.isRegistered(e))try{const n=this._extractDataFromElement(t),s=await l.render(e,t,n);s&&this.children.add(s)}catch(t){console.error(`[DOM Components] Error rendering nested component ${e}:`,t)}}}_extractDataFromElement(e){const t={};return Array.from(e.attributes).forEach(e=>{if("data-component"!==e.name){const n=e.name.replace(/^data-/,"").replace(/-([a-z])/g,(e,t)=>t.toUpperCase());let s=e.value;try{"true"===s?s=!0:"false"===s?s=!1:isNaN(s)||""===s?(s.startsWith("{")&&s.endsWith("}")||s.startsWith("[")&&s.endsWith("]"))&&(s=JSON.parse(s)):s=Number(s)}catch(e){}t[n]=s}}),t}_enhanceWithDOMHelpers(){this.container.querySelectorAll("*").forEach(t=>{e.EnhancedUpdateUtility&&e.EnhancedUpdateUtility.enhanceElementWithUpdate&&e.EnhancedUpdateUtility.enhanceElementWithUpdate(t)}),e.EnhancedUpdateUtility&&e.EnhancedUpdateUtility.enhanceElementWithUpdate&&e.EnhancedUpdateUtility.enhanceElementWithUpdate(this.container)}async updateData(e){if(!this.isDestroyed)try{await this._callLifecycle("beforeUpdate");const t={...this.data};Object.assign(this.data,e),i.set(this,this.data),this.emit("dataChanged",{oldData:t,newData:this.data,changes:e}),await this._callLifecycle("updated")}catch(e){console.error(`[DOM Components] Error updating component ${this.name}:`,e)}}_deepMergeUpdates(e,t){Object.entries(t).forEach(([t,n])=>{if("object"!=typeof n||null===n||Array.isArray(n))e[t]=n;else{Object.keys(n).some(e=>"style"===e||"dataset"===e)&&e[t]?(e[t]=e[t]||{},Object.entries(n).forEach(([n,s])=>{e[t][n]="style"!==n&&"dataset"!==n||"object"!=typeof s?s:{...e[t][n],...s}})):e[t]=n}})}update(e,t={}){this.isDestroyed||(this._updateQueue||(this._updateQueue={},this._updateScheduled=!1),this._deepMergeUpdates(this._updateQueue,e),t.immediate?this._flushUpdates():this._updateScheduled||(this._updateScheduled=!0,"undefined"!=typeof requestAnimationFrame?this._rafId=requestAnimationFrame(()=>{this._flushUpdates()}):this._rafId=setTimeout(()=>{this._flushUpdates()},16)))}_flushUpdates(){if(this.isDestroyed||!this._updateQueue)return;const e=this._updateQueue;this._updateQueue={},this._updateScheduled=!1;try{this._applyUpdatesWithCoreSystem(e)}catch(e){console.error(`[DOM Components] Error flushing updates for ${this.name}:`,e)}}_applyUpdatesWithCoreSystem(e){if(!("undefined"!=typeof applyEnhancedUpdate))return console.warn("[DOM Components] Core fine-grained update system not available, using fallback"),this._applyUpdatesFallback(e);Object.entries(e).forEach(([e,t])=>{if(e.includes(".")){const n=e.indexOf("."),s=e.substring(0,n),o=e.substring(n+1),i=this.container.querySelector(`#${s}`)||("undefined"!=typeof Elements?Elements[s]:null);if(!i)return;if(o.includes(".")){const e=o.split(".");let n=i;for(let t=0;t<e.length-1;t++){if(!n[e[t]])return;n=n[e[t]]}n[e[e.length-1]]=t}else{({})[o]=t,applyEnhancedUpdate(i,o,t)}}else{const n=this.container.querySelector(`#${e}`)||("undefined"!=typeof Elements?Elements[e]:null);if(!n)return;"object"!=typeof t||null===t||Array.isArray(t)?applyEnhancedUpdate(n,"textContent",t):Object.entries(t).forEach(([e,t])=>{applyEnhancedUpdate(n,e,t)})}})}_applyUpdatesFallback(e){Object.entries(e).forEach(([e,t])=>{if(e.includes(".")){const[n,...s]=e.split("."),o=this.container.querySelector(`#${n}`);if(o){let e=o;for(let t=0;t<s.length-1;t++){if(!e[s[t]])return void console.warn(`[DOM Components] Property "${s[t]}" not found on element "${n}"`);e=e[s[t]]}const i=s[s.length-1];e[i]!==t&&(e[i]=t)}}else{const n=this.container.querySelector(`#${e}`);n&&"object"==typeof t&&null!==t&&Object.entries(t).forEach(([e,t])=>{"style"===e&&"object"==typeof t?Object.entries(t).forEach(([e,t])=>{n.style[e]!==t&&(n.style[e]=t)}):"classList"===e&&"object"==typeof t?Object.entries(t).forEach(([e,t])=>{const s=Array.isArray(t)?t:[t];"function"==typeof n.classList[e]&&s.forEach(t=>n.classList[e](t))}):"dataset"===e&&"object"==typeof t?Object.entries(t).forEach(([e,t])=>{n.dataset[e]!==t&&(n.dataset[e]=t)}):n[e]!==t&&(n[e]=t)})}})}async refresh(){if(!this.isDestroyed)try{await this._callLifecycle("beforeUpdate"),await this.render(),await this._callLifecycle("updated")}catch(e){console.error(`[DOM Components] Error refreshing component ${this.name}:`,e)}}async smartUpdate(e,t=null){if(!this.isDestroyed)try{await this.updateData(e),t&&this.update(t)}catch(e){console.error(`[DOM Components] Error in smart update for ${this.name}:`,e)}}emit(e,t={}){const n=new CustomEvent(`component:${e}`,{detail:{component:this,componentName:this.name,data:t},bubbles:!0,cancelable:!0});this.container.dispatchEvent(n),document.dispatchEvent(n)}on(e,t){this.lifecycle[e]&&this.lifecycle[e].push(t)}async _callLifecycle(e){const t=this.lifecycle[e]||[];for(const n of t)try{await n.call(this)}catch(t){console.error(`[DOM Components] Error in ${e} lifecycle:`,t)}}async destroy(){if(!this.isDestroyed)try{await this._callLifecycle("beforeDestroy"),this._updateScheduled&&this._rafId&&("undefined"!=typeof cancelAnimationFrame&&cancelAnimationFrame(this._rafId),this._updateScheduled=!1),this._updateQueue&&(this._updateQueue={});for(const e of this.children)await e.destroy();if(this.children.clear(),o.has(this.scopeId)){const e=o.get(this.scopeId);e.parentNode&&e.parentNode.removeChild(e),o.delete(this.scopeId)}this.container&&(this.container.innerHTML=""),s.delete(this.container),i.delete(this),this.isDestroyed=!0,this.isMounted=!1,await this._callLifecycle("destroyed")}catch(e){console.error(`[DOM Components] Error destroying component ${this.name}:`,e)}}}function c(e){return e?new Proxy(e,{get:(e,t)=>"update"===t?function(e){return function(e){return{_isUpdateCall:!0,_updates:e}}(e)}:e[t]}):null}const l={update:function(e={}){e&&"object"==typeof e?Object.entries(e).forEach(([e,t])=>{if(e.includes(".")){const n=e.indexOf("."),s=e.substring(0,n),o=e.substring(n+1),i=Elements[s];if(i)if(o.includes(".")){const e=o.split(".");let n=i;for(let t=0;t<e.length-1;t++){if(!n[e[t]])return void console.warn(`[DOM Components] Property "${e[t]}" not found on element "${s}"`);n=n[e[t]]}n[e[e.length-1]]=t}else o in i?i[o]=t:i.setAttribute(o,t);else console.warn(`[DOM Components] Element with id "${s}" not found`)}else{const n=Elements[e];n?"object"!=typeof t||null===t||Array.isArray(t)?console.warn(`[DOM Components] Invalid update value for element "${e}"`):t._isUpdateCall?n.update(t._updates):n.update(t):console.warn(`[DOM Components] Element with id "${e}" not found`)}}):console.warn("[DOM Components] .update() called with invalid updates object")},register(e,t){if("string"!=typeof e)throw new Error("[DOM Components] Component name must be a string");return n.has(e)&&console.warn(`[DOM Components] Component "${e}" already registered. Overwriting.`),n.set(e,t),console.log(`[DOM Components] Component "${e}" registered`),this},async load(e,t){try{const n=await fetch(t);if(!n.ok)throw new Error(`HTTP ${n.status}: ${n.statusText}`);const s=await n.text();return this.register(e,s),this}catch(n){throw console.error(`[DOM Components] Failed to load component "${e}" from ${t}:`,n),n}},async render(e,t,o={}){if(!n.has(e))throw new Error(`[DOM Components] Component "${e}" not registered`);if("string"==typeof t&&!(t=Elements[t]||document.querySelector(t)))throw new Error(`[DOM Components] Container not found: ${t}`);const i=s.get(t);i&&await i.destroy();const r=n.get(e),c=new a(e,r,t,o);return await c.render(),c},async renderInline(e,t,n={}){const s=`inline-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;return this.register(s,e),this.render(s,t,n)},scope(...e){const t={};return 0===e.length?new Proxy({},{get(e,t){if("string"==typeof t){return c(Elements[t])}}}):(e.forEach(e=>{const n=Elements[e];n?t[e]=c(n):(console.warn(`[DOM Components] Element "${e}" not found in scope`),t[e]=null)}),t)},batchUpdate(e){if(e&&"object"==typeof e)return Object.entries(e).forEach(([e,t])=>{const n=Elements[e];if(n&&"function"==typeof n.update)try{n.update(t)}catch(t){console.error(`[DOM Components] Error updating element "${e}":`,t)}else n||console.warn(`[DOM Components] Element "${e}" not found for batchUpdate`)}),this;console.warn("[DOM Components] batchUpdate called with invalid updates object")},createBinding:(e,t)=>({update(e){const n=t(e);l.batchUpdate(n)},elements:e.reduce((e,t)=>(e[t]=Elements[t],e),{})}),getInstance:e=>("string"==typeof e&&(e=Elements[e]||document.querySelector(e)),s.get(e)),async destroy(e){const t=this.getInstance(e);return!!t&&(await t.destroy(),!0)},isRegistered:e=>n.has(e),getRegistered:()=>Array.from(n.keys()),unregister(e){const t=n.delete(e);return t&&console.log(`[DOM Components] Component "${e}" unregistered`),t},async autoInit(e=document){const t=e.querySelectorAll("[data-component]");for(const e of t){const t=e.getAttribute("data-component");if(t&&this.isRegistered(t)&&!s.has(e))try{const n=this._extractDataFromElement(e);await this.render(t,e,n)}catch(e){console.error(`[DOM Components] Auto-init failed for ${t}:`,e)}}await this._processCustomTags(e)},async _processCustomTags(e=document){const t=e.querySelectorAll("*"),n=Array.from(t).filter(e=>{const t=e.tagName.toLowerCase();return this._isComponentTag(t)&&!s.has(e)});for(const e of n){const t=e.tagName.toLowerCase(),n=this._tagNameToComponentName(t);if(this.isRegistered(n))try{const t=this._extractPropsFromElement(e),s=document.createElement("div");s.className=`${n.toLowerCase()}-container`,e.parentNode.replaceChild(s,e),await this.render(n,s,t)}catch(e){console.error(`[DOM Components] Error processing custom tag <${t}>:`,e)}}},_isComponentTag:e=>!new Set(["a","abbr","address","area","article","aside","audio","b","base","bdi","bdo","blockquote","body","br","button","canvas","caption","cite","code","col","colgroup","data","datalist","dd","del","details","dfn","dialog","div","dl","dt","em","embed","fieldset","figcaption","figure","footer","form","h1","h2","h3","h4","h5","h6","head","header","hgroup","hr","html","i","iframe","img","input","ins","kbd","label","legend","li","link","main","map","mark","meta","meter","nav","noscript","object","ol","optgroup","option","output","p","param","picture","pre","progress","q","rp","rt","ruby","s","samp","script","section","select","small","source","span","strong","style","sub","summary","sup","svg","table","tbody","td","template","textarea","tfoot","th","thead","time","title","tr","track","u","ul","var","video","wbr"]).has(e)&&(e.includes("-")?/^[a-z]+(-[a-z0-9]+)+$/.test(e):/^[a-z][a-z0-9]*$/.test(e)&&e.length>2),_tagNameToComponentName(e){if(e.includes("-"))return e.split("-").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join("");{if(this.isRegistered(e))return e;const t=e.charAt(0).toUpperCase()+e.slice(1);if(this.isRegistered(t))return t;const n=this.getRegistered(),s=e.toLowerCase();for(const e of n)if(e.toLowerCase()===s)return e;return t}},_extractPropsFromElement(e){const t={};return Array.from(e.attributes).forEach(e=>{const n=this._attributeNameToPropName(e.name);let s=e.value;try{"true"===s?s=!0:"false"===s?s=!1:"null"===s?s=null:"undefined"===s?s=void 0:isNaN(s)||""===s||isNaN(Number(s))?(s.startsWith("{")&&s.endsWith("}")||s.startsWith("[")&&s.endsWith("]"))&&(s=JSON.parse(s)):s=Number(s)}catch(e){}t[n]=s}),e.innerHTML.trim()&&(t.children=e.innerHTML.trim()),t},_attributeNameToPropName:e=>e.replace(/-([a-z])/g,(e,t)=>t.toUpperCase()),async processHTML(e,t){const n=document.createElement("div");if(n.innerHTML=e,await this._processCustomTags(n),t)for(t.innerHTML="";n.firstChild;)t.appendChild(n.firstChild);return n.innerHTML},_extractDataFromElement(e){const t={};return Array.from(e.attributes).forEach(e=>{if("data-component"!==e.name&&e.name.startsWith("data-")){const n=e.name.replace(/^data-/,"").replace(/-([a-z])/g,(e,t)=>t.toUpperCase());let s=e.value;try{"true"===s?s=!0:"false"===s?s=!1:isNaN(s)||""===s?(s.startsWith("{")&&s.endsWith("}")||s.startsWith("[")&&s.endsWith("]"))&&(s=JSON.parse(s)):s=Number(s)}catch(e){}t[n]=s}}),t},getStats:()=>({registered:n.size,active:Array.from(s.values()).filter(e=>!e.isDestroyed).length,scopedStyles:o.size}),async destroyAll(){const e=Array.from(s.values());for(const t of e)t.isDestroyed||await t.destroy()},configure(e={}){return this}};"undefined"!=typeof document&&("loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{setTimeout(()=>l.autoInit(),0)}):setTimeout(()=>l.autoInit(),0),window.addEventListener("beforeunload",()=>{l.destroyAll()})),void 0!==e.Elements&&e.Elements&&(e.Elements.update=l.update,console.log("[DOM Components] Elements.update() enhanced with dot notation support")),"undefined"!=typeof module&&module.exports?module.exports={Components:l,Component:a}:"function"==typeof define&&define.amd?define([],function(){return{Components:l,Component:a}}):(e.Components=l,e.Component=a),console.log("[DOM Components] Traditional HTML5 component system loaded")}("undefined"!=typeof window?window:"undefined"!=typeof global?global:this);