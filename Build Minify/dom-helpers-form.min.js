/**
 * DOM Helpers - Form Module
 * Specialized form handling utilities that integrate with the main DOM Helpers library
 * 
 * Features:
 * - Forms object for accessing forms by ID
 * - Automatic form value extraction and setting
 * - Declarative form handling with .update() method
 * - Seamless integration with Elements, Collections, and Selector
 * - Enhanced form validation and submission handling
 * 
 * @version 1.0.0
 * @license MIT
 */
!function(e){"use strict";if(void 0===e.Elements&&"undefined"==typeof Elements)return void console.warn("[DOM Helpers Form] Main DOM Helpers library must be loaded before the Form module");function t(e){if(!e||e._hasFormMethods)return e;Object.defineProperty(e,"_hasFormMethods",{value:!0,writable:!1,enumerable:!1,configurable:!1}),Object.defineProperty(e,"values",{get:function(){return r(e)},set:function(t){s(e,t)},enumerable:!0,configurable:!0});const t=e.reset;return e.reset=function(r={}){return!1!==r.clearCustom&&l(e),t.call(e),e.dispatchEvent(new CustomEvent("formreset",{detail:{form:e},bubbles:!0})),e},e.validate=function(t={}){return i(e,t)},e.clearValidation=function(){return l(e),e},e.submitData=function(t={}){return async function(e,t={}){const{url:s=e.action||window.location.href,method:n=e.method||"POST",validate:o=!0,validationRules:a={},beforeSubmit:c=null,onSuccess:l=null,onError:d=null,transform:u=null}=t;try{if(o){const t=i(e,a);if(!t.isValid)return d&&d(new Error("Validation failed"),t.errors),{success:!1,errors:t.errors}}let t=r(e);if("function"==typeof u&&(t=u(t)),"function"==typeof c){if(!1===await c(t,e))return{success:!1,cancelled:!0}}const h={method:n.toUpperCase(),headers:{"Content-Type":"application/json"}};"GET"!==n.toUpperCase()&&(h.body=JSON.stringify(t));const m=await fetch(s,h),f=await m.json();if(m.ok)return l&&l(f,t),{success:!0,data:f};throw new Error(f.message||"Submission failed")}catch(e){return d&&d(e),{success:!1,error:e.message}}}(e,t)},e.getField=function(t){return n(e,t)},e.setField=function(t,r){return o(e,t,r),e},e.serialize=function(t="object"){return function(e,t="object"){const s=r(e);switch(t){case"json":return JSON.stringify(s);case"formdata":const e=new FormData;return Object.entries(s).forEach(([t,r])=>{Array.isArray(r)?r.forEach(r=>e.append(t,r)):e.append(t,r)}),e;case"urlencoded":return new URLSearchParams(s).toString();default:return s}}(e,t)},e}function r(e){const t={},r=new FormData(e);for(const[e,s]of r.entries())t[e]?Array.isArray(t[e])?t[e].push(s):t[e]=[t[e],s]:t[e]=s;return e.querySelectorAll('input[type="checkbox"], input[type="radio"]').forEach(e=>{e.checked||!e.name||t.hasOwnProperty(e.name)||"checkbox"===e.type&&(t[e.name]=!1)}),t}function s(e,t){t&&"object"==typeof t?Object.entries(t).forEach(([t,r])=>{o(e,t,r)}):console.warn("[DOM Helpers Form] Invalid values object provided to setFormValues")}function n(e,t){let r=e.querySelector(`[name="${t}"]`);return r||(r=e.querySelector(`#${t}`)),r}function o(e,t,r){const s=e.querySelectorAll(`[name="${t}"]`);if(0===s.length){const s=e.querySelector(`#${t}`);return void(s&&a(s,r))}1===s.length?a(s[0],r):s.forEach(e=>{"radio"===e.type?e.checked=e.value===String(r):"checkbox"===e.type?Array.isArray(r)?e.checked=r.includes(e.value):e.checked=Boolean(r):a(e,r)})}function a(e,t){if(e){switch(e.type){case"checkbox":e.checked=Boolean(t);break;case"radio":e.checked=e.value===String(t);break;case"file":console.warn("[DOM Helpers Form] Cannot set file input values programmatically");break;case"select-multiple":Array.isArray(t)&&Array.from(e.options).forEach(e=>{e.selected=t.includes(e.value)});break;default:e.value=t}e.dispatchEvent(new Event("change",{bubbles:!0}))}}function i(e,t={}){const s={},o=r(e);l(e);if(!e.checkValidity()){e.querySelectorAll(":invalid").forEach(e=>{e.name&&(s[e.name]=e.validationMessage||"Invalid value",c(e,s[e.name]))})}return Object.entries(t).forEach(([t,r])=>{const a=o[t],i=n(e,t);if("function"==typeof r){const e=r(a,o,i);!0!==e&&void 0!==e&&(s[t]=e||"Invalid value",i&&c(i,s[t]))}else"object"==typeof r&&Object.entries(r).forEach(([e,r])=>{if(s[t])return;let n=!1,l="";switch(e){case"required":r&&(!a||"string"==typeof a&&""===a.trim())&&(n=!0,l="This field is required");break;case"minLength":a&&a.length<r&&(n=!0,l=`Minimum length is ${r} characters`);break;case"maxLength":a&&a.length>r&&(n=!0,l=`Maximum length is ${r} characters`);break;case"pattern":a&&!new RegExp(r).test(a)&&(n=!0,l="Invalid format");break;case"email":r&&a&&!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(a)&&(n=!0,l="Invalid email address");break;case"custom":if("function"==typeof r){const e=r(a,o,i);!0!==e&&void 0!==e&&(n=!0,l=e||"Invalid value")}}n&&(s[t]=l,i&&c(i,l))})}),{isValid:0===Object.keys(s).length,errors:s,values:o}}function c(e,t){e.classList.add("form-invalid"),e.setAttribute("aria-invalid","true");let r=e.parentNode.querySelector(".form-error-message");r||(r=document.createElement("div"),r.className="form-error-message",r.style.color="#dc3545",r.style.fontSize="0.875em",r.style.marginTop="0.25rem",e.parentNode.appendChild(r)),r.textContent=t}function l(e){e.querySelectorAll(".form-invalid").forEach(e=>{e.classList.remove("form-invalid"),e.removeAttribute("aria-invalid")});e.querySelectorAll(".form-error-message").forEach(e=>e.remove())}class d{constructor(e={}){this.cache=new Map,this.options={enableLogging:e.enableLogging??!1,autoCleanup:e.autoCleanup??!0,cleanupInterval:e.cleanupInterval??3e4,maxCacheSize:e.maxCacheSize??500,autoValidation:e.autoValidation??!1,...e},this.stats={hits:0,misses:0,cacheSize:0,lastCleanup:Date.now()},this.cleanupTimer=null,this.isDestroyed=!1,this._initProxy(),this._initMutationObserver(),this._scheduleCleanup()}_initProxy(){this.Forms=new Proxy(this,{get:(e,t)=>"symbol"==typeof t||t.startsWith("_")||"function"==typeof e[t]?e[t]:e._getForm(t),has:(e,t)=>e._hasForm(t),ownKeys:e=>e._getKeys(),getOwnPropertyDescriptor:(e,t)=>{if(e._hasForm(t))return{enumerable:!0,configurable:!0,value:e._getForm(t)}}})}_getForm(e){if("string"!=typeof e)return this._warn("Invalid form property type: "+typeof e),null;if(this.cache.has(e)){const t=this.cache.get(e);if(t&&t.nodeType===Node.ELEMENT_NODE&&document.contains(t))return this.stats.hits++,t._isEnhancedForm?t:this._enhanceForm(t);this.cache.delete(e)}const t=document.getElementById(e);if(t&&"form"===t.tagName.toLowerCase()){const r=t._isEnhancedForm?t:this._enhanceForm(t);return this._addToCache(e,r),this.stats.misses++,r}return this.stats.misses++,this.options.enableLogging&&this._warn(`Form with id '${e}' not found`),null}_hasForm(e){if("string"!=typeof e)return!1;if(this.cache.has(e)){const t=this.cache.get(e);if(t&&t.nodeType===Node.ELEMENT_NODE&&document.contains(t))return!0;this.cache.delete(e)}const t=document.getElementById(e);return t&&"form"===t.tagName.toLowerCase()}_getKeys(){const e=document.querySelectorAll("form[id]");return Array.from(e).map(e=>e.id).filter(e=>e)}_enhanceForm(r){if(!r||r._isEnhancedForm)return r;try{e.Elements&&e.Elements.helper?r=e.Elements.helper._enhanceElementWithUpdate(r):"undefined"!=typeof Elements&&Elements.helper&&(r=Elements.helper._enhanceElementWithUpdate(r))}catch(e){console.warn("[DOM Helpers Form] Could not enhance with Elements helper:",e.message)}return(r=t(r)).update?r.update=function(e){const t=e.update;return function(r={}){if(!r||"object"!=typeof r)return console.warn("[DOM Helpers Form] .update() called with invalid updates object"),e;const n={...r};if(n.values&&(s(e,n.values),delete n.values),n.validate){const t=!0===n.validate?{}:n.validate;i(e,t),delete n.validate}if(n.reset){const t=!0===n.reset?{}:n.reset;e.reset(t),delete n.reset}if(n.submit){const t=!0===n.submit?{}:n.submit;e.submitData(t),delete n.submit}return Object.keys(n).length>0?t.call(e,n):e}}(r):r.update=function(e={}){if(!e||"object"!=typeof e)return console.warn("[DOM Helpers Form] .update() called with invalid updates object"),r;const t={...e};if(t.values&&(s(r,t.values),delete t.values),t.validate){const e=!0===t.validate?{}:t.validate;i(r,e),delete t.validate}if(t.reset){const e=!0===t.reset?{}:t.reset;r.reset(e),delete t.reset}if(t.submit){const e=!0===t.submit?{}:t.submit;r.submitData(e),delete t.submit}return t.addEventListener&&("function"==typeof handleEnhancedEventListener?handleEnhancedEventListener(r,t.addEventListener):"object"==typeof t.addEventListener&&Object.entries(t.addEventListener).forEach(([e,t])=>{"function"==typeof t&&r.addEventListener(e,t)}),delete t.addEventListener),Object.entries(t).forEach(([e,t])=>{try{e in r?r[e]=t:"string"!=typeof t&&"number"!=typeof t&&"boolean"!=typeof t||r.setAttribute(e,t)}catch(t){console.warn(`[DOM Helpers Form] Could not set ${e}:`,t.message)}}),r},Object.defineProperty(r,"_isEnhancedForm",{value:!0,writable:!1,enumerable:!1,configurable:!1}),r}_addToCache(e,t){if(this.cache.size>=this.options.maxCacheSize){const e=this.cache.keys().next().value;this.cache.delete(e)}this.cache.set(e,t),this.stats.cacheSize=this.cache.size}_initMutationObserver(){this.observer=new MutationObserver(e=>{this._processMutations(e)}),document.body?this.observer.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["id"],attributeOldValue:!0}):document.addEventListener("DOMContentLoaded",()=>{document.body&&!this.isDestroyed&&this.observer.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["id"],attributeOldValue:!0})})}_processMutations(e){if(this.isDestroyed)return;const t=new Set,r=new Set;e.forEach(e=>{if(e.addedNodes.forEach(e=>{e.nodeType===Node.ELEMENT_NODE&&"form"===e.tagName.toLowerCase()&&e.id&&t.add(e.id)}),e.removedNodes.forEach(e=>{e.nodeType===Node.ELEMENT_NODE&&"form"===e.tagName.toLowerCase()&&e.id&&r.add(e.id)}),"attributes"===e.type&&"id"===e.attributeName){const s=e.target;if("form"===s.tagName.toLowerCase()){const n=e.oldValue,o=s.id;n&&n!==o&&r.add(n),o&&o!==n&&t.add(o)}}}),t.forEach(e=>{const t=document.getElementById(e);t&&"form"===t.tagName.toLowerCase()&&this._addToCache(e,t)}),r.forEach(e=>{this.cache.delete(e)}),this.stats.cacheSize=this.cache.size}_scheduleCleanup(){this.options.autoCleanup&&!this.isDestroyed&&(this.cleanupTimer=setTimeout(()=>{this._performCleanup(),this._scheduleCleanup()},this.options.cleanupInterval))}_performCleanup(){if(this.isDestroyed)return;const e=[];for(const[t,r]of this.cache)r&&r.nodeType===Node.ELEMENT_NODE&&document.contains(r)&&r.id===t&&"form"===r.tagName.toLowerCase()||e.push(t);e.forEach(e=>this.cache.delete(e)),this.stats.cacheSize=this.cache.size,this.stats.lastCleanup=Date.now(),this.options.enableLogging&&e.length>0&&this._log(`Cleanup completed. Removed ${e.length} stale entries.`)}_log(e){this.options.enableLogging&&console.log(`[Forms] ${e}`)}_warn(e){this.options.enableLogging&&console.warn(`[Forms] ${e}`)}getStats(){return{...this.stats,hitRate:this.stats.hits/(this.stats.hits+this.stats.misses)||0,uptime:Date.now()-this.stats.lastCleanup}}clearCache(){this.cache.clear(),this.stats.cacheSize=0,this._log("Cache cleared manually")}destroy(){this.isDestroyed=!0,this.observer&&(this.observer.disconnect(),this.observer=null),this.cleanupTimer&&(clearTimeout(this.cleanupTimer),this.cleanupTimer=null),this.cache.clear(),this._log("Forms helper destroyed")}getAllForms(){const e=document.querySelectorAll("form[id]");return Array.from(e).map(e=>e._isEnhancedForm?e:this._enhanceForm(e))}validateAll(e={}){const t={};return this.getAllForms().forEach(r=>{r.id&&(t[r.id]=r.validate(e[r.id]||{}))}),t}resetAll(){this.getAllForms().forEach(e=>e.reset())}}const u=new d({enableLogging:!1,autoCleanup:!0,cleanupInterval:3e4,maxCacheSize:500}),h=u.Forms;h.helper=u,h.stats=()=>u.getStats(),h.clear=()=>u.clearCache(),h.destroy=()=>u.destroy(),h.getAllForms=()=>u.getAllForms(),h.validateAll=e=>u.validateAll(e),h.resetAll=()=>u.resetAll(),h.configure=e=>(Object.assign(u.options,e),h),"undefined"!=typeof module&&module.exports?module.exports={Forms:h,ProductionFormsHelper:d}:"function"==typeof define&&define.amd?define([],function(){return{Forms:h,ProductionFormsHelper:d}}):(e.Forms=h,e.ProductionFormsHelper=d),"undefined"!=typeof window&&window.addEventListener("beforeunload",()=>{u.destroy()}),e.DOMHelpers&&(e.DOMHelpers.Forms=h,e.DOMHelpers.ProductionFormsHelper=d),console.log("[DOM Helpers Form] Form module loaded successfully")}("undefined"!=typeof window?window:"undefined"!=typeof global?global:this);